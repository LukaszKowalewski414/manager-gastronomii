{% extends 'base.html' %}

{% block content %}

{% set MONTHS = {
    1: "Stycze≈Ñ", 2: "Luty", 3: "Marzec", 4: "Kwiecie≈Ñ",
    5: "Maj", 6: "Czerwiec", 7: "Lipiec", 8: "Sierpie≈Ñ",
    9: "Wrzesie≈Ñ", 10: "Pa≈∫dziernik", 11: "Listopad", 12: "Grudzie≈Ñ"
} %}

<div class="container my-5">

    <!-- Formularz wyboru miesiƒÖca i roku -->
    <form method="get" action="{{ url_for('monthly_summary') }}" class="mb-4 text-center">
        <h2 class="text-primary mb-3">Podsumowanie ‚Äì {{ MONTHS[selected_month] }} {{ selected_year }}</h2>

        <div class="d-inline-block me-2">
            <label for="month">MiesiƒÖc:</label>
            <select name="month" id="month" class="form-select d-inline w-auto">
                {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>
                        {{ MONTHS[m] }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="d-inline-block me-2">
            <label for="year">Rok:</label>
            <select name="year" id="year" class="form-select d-inline w-auto">
                {% for y in range(2023, 2026) %}
                    <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="btn btn-primary ms-2">Poka≈º</button>
    </form>

    <!-- Karty z liczbami -->
    <div class="row text-center mb-5">
        <div class="col-md-4">
            <div class="card p-3 shadow">
                <h5>üí∞ Suma utarg√≥w</h5>
                <h3>{{ summary.total_revenue | round(2) }} z≈Ç</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 shadow">
                <h5>üìâ Suma koszt√≥w</h5>
                <h3>{{ summary.total_costs | round(2) }} z≈Ç</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 shadow">
                <h5>üìä Wynik</h5>
                <h3 class="{{ 'text-success' if summary.net_result >= 0 else 'text-danger' }}">
                    {{ summary.net_result | round(2) }} z≈Ç
                </h3>
            </div>
        </div>
    </div>

    <!-- Wykresy -->
    <div class="row mb-5">
        <div class="col-md-6">
            <canvas id="barChart"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="pieChart"></canvas>
        </div>
    </div>

    <!-- Tabela koszt√≥w -->
    <h4 class="mb-3">Koszty wed≈Çug kategorii</h4>
    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th>Kategoria</th>
                <th>Kwota</th>
            </tr>
        </thead>
        <tbody>
            {% for cat, amount in summary.cost_by_category.items() %}
            <tr>
                <td>{{ cat }}</td>
                <td>{{ amount | round(2) }} z≈Ç</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const barChart = new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: ['Utargi', 'Koszty'],
            datasets: [{
                label: 'z≈Ç',
                data: [{{ summary.total_revenue }}, {{ summary.total_costs }}],
                backgroundColor: ['#198754', '#dc3545']
            }]
        }
    });

    const pieChart = new Chart(document.getElementById('pieChart'), {
        type: 'pie',
        data: {
            labels: {{ summary.cost_by_category.keys() | list | tojson }},
            datasets: [{
                data: {{ summary.cost_by_category.values() | list | tojson }},
                backgroundColor: [
                    '#0d6efd', '#6610f2', '#6f42c1',
                    '#198754', '#ffc107', '#dc3545'
                ]
            }]
        }
    });
</script>

<!-- Lista faktur -->
<div class="d-flex justify-content-between align-items-center mb-3 mt-5">
    <h4 class="mb-0">Faktury za {{ MONTHS[selected_month] }} {{ selected_year }}</h4>
    <a href="{{ url_for('add_invoice') }}" class="btn btn-primary btn-sm py-1 px-2">+ dodaj fakturƒô</a>
</div>
<table class="table table-striped">
    <thead class="table-light">
        <tr>
            <th>Data</th>
            <th>Kwota brutto</th>
            <th>Dostawca</th>
            <th>NIP</th>
            <th>Kategoria</th>
            <th>Akcje</th>
        </tr>
    </thead>
    <tbody>
        {% for invoice in invoices %}
        <tr>
            <td>{{ invoice.invoice_date }}</td>
            <td>{{ invoice.gross_amount }} z≈Ç</td>
            <td>{{ invoice.supplier_name }}</td>
            <td>{{ invoice.supplier_nip }}</td>
            <td>{{ invoice.category }}</td>
            <td>
                <a href="{{ url_for('edit_invoice', invoice_id=invoice.id) }}" class="btn btn-sm btn-outline-secondary me-2">edytuj</a>
                <form action="{{ url_for('delete_invoice', invoice_id=invoice.id) }}" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Na pewno chcesz usunƒÖƒá tƒô fakturƒô?')">usu≈Ñ</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}
